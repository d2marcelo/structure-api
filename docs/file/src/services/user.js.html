<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/services/user.js | Structure Core API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/structurejs/core.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/root.js~RootController.html">RootController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/applications</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/applications/index.js~ApplicationController.html">ApplicationController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/auth/index.js~AuthController.html">AuthController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/buckets</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/buckets/index.js~BucketsController.html">BucketsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/digital-assets</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/digital-assets/index.js~DigitalAssetsController.html">DigitalAssetsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/document-revisions</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/document-revisions/index.js~DocumentRevisionsController.html">DocumentRevisionsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/documents</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/documents/index.js~DocumentsController.html">DocumentsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/fields</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/fields/index.js~FieldsController.html">FieldsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/organizations</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/organizations/index.js~OrganizationsController.html">OrganizationsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/registry/index.js~RegistryController.html">RegistryController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/taxonomies</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/taxonomies/index.js~TaxonomiesController.html">TaxonomiesController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/template-revisions</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/template-revisions/index.js~TemplateRevisionsController.html">TemplateRevisionsController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/templates</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/templates/index.js~TemplatesController.html">TemplatesController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">controllers/users</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/controllers/users/index.js~UsersController.html">UsersController</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/eventemitter.js~EventEmitter.html">EventEmitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/mapper.js~Mapper.html">Mapper</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mixin">mixin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-logger">logger</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/database</div><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-config">config</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-r">r</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/utils</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-generateUUID">generateUUID</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">lib/utils/object</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ObjectEach">ObjectEach</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ObjectMap">ObjectMap</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">mixins</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mixins/log.js~Log.html">Log</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mixins/middleware.js~Middleware.html">Middleware</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mixins/scrape.js~Scrape.html">Scrape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/mixins/stream-extras.js~StreamExtras.html">StreamExtras</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-mixin">mixin</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/root.js~RootModel.html">RootModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/application</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/application/index.js~AppModel.html">AppModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/auth</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/auth/index.js~AuthModel.html">AuthModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/bucket</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/bucket/index.js~BucketModel.html">BucketModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/channel</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/channel/index.js~ChannelModel.html">ChannelModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/digital-asset</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/digital-asset/index.js~DigitalAssetModel.html">DigitalAssetModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/document</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/document/index.js~DocumentModel.html">DocumentModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/document-revision</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/document-revision/index.js~DocumentRevisionModel.html">DocumentRevisionModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/field</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/field/index.js~FieldModel.html">FieldModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/organization</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/organization/index.js~OrganizationModel.html">OrganizationModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/registry</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/registry/index.js~RegistryModel.html">RegistryModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/revision</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/revision/index.js~RevisionModel.html">RevisionModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/taxonomy</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/taxonomy/index.js~TaxonomyModel.html">TaxonomyModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/template</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/template/index.js~TemplateModel.html">TemplateModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/template-revision</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/template-revision/index.js~TemplateRevisionModel.html">TemplateRevisionModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">models/user</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/models/user/index.js~UserModel.html">UserModel</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">server</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/dispatcher.js~Dispatcher.html">Dispatcher</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/server/router.js~Router.html">Router</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">services</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/app.js~AppService.html">AppService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/auth.js~AuthService.html">AuthService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/organization.js~OrganizationService.html">OrganizationService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/package.js~PackageService.html">PackageService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/password.js~PasswordService.html">PasswordService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/short-id.js~ShortIdService.html">ShortIdService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/template.js~TemplateService.html">TemplateService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/token.js~TokenService.html">TokenService</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/services/user.js~UserService.html">UserService</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/services/user.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import async           from &apos;async&apos;
import {chalk, logger} from &apos;../lib/logger&apos;
import PasswordService from &apos;./password&apos;
import ShortIdService  from &apos;../services/short-id&apos;
import TokenService    from &apos;./token&apos;
import UserModel       from &apos;../models/user&apos;

class UserService {

  create(o = {}, cb) {
    var _this = this

    var pkg = Object.assign({}, o)

    // validation

    var passwordService = new PasswordService(),
        shortidService  = new ShortIdService(),
        tokenService    = new TokenService(),
        userModel       = new UserModel()

    /*
    TODO: clean up this query, it could be optimized
    */
    passwordService.issue(pkg.password, function UserService_createIssueCallback(err, hash) {

      if(err) {
        logger.error(err)
        logger.debug(&apos;cb&apos;, typeof cb)
        return cb({
          message: &apos;Could not create password hash&apos;,
          resource: &apos;UserModel&apos;
        })
      }

      if(pkg.password) delete pkg.password // dont want to store actual password
      if(pkg.organizationId) delete pkg.organizationId

      pkg.hash = hash
      pkg.organizations = pkg.organizations || []

      async.parallel([
        userModel.create.bind(userModel, pkg)
      ], function UserService_createParallelCallback(err, res) {

        if(err) {
          logger.error(err)
          return cb({
            raw: err,
            resource: &apos;UserModel&apos;
          })
        }

        var user = res[0]
        var sid  = shortidService.issue(user.id)

        async.parallel([
          tokenService.issue.bind(tokenService, user.id),
          userModel.addToOrganizationTable.bind(userModel, user.id, o.organizations[0]),
          _this.update.bind(_this, user.id, {sid})
        ], function UserService_createParallelCallback2(err2, res2) {

          if(err2) {
            logger.error(err2)
            return cb({
              raw: err2,
              resource: &apos;UserModel&apos;
            })
          }

          user               = res2[2]
          user.organizations = res2[1].organizations
          user.token         = res2[0]

          cb(null, user)

        })

      })

    })

  }

  get() {
    var userModel = new UserModel()

    userModel.get.apply(userModel, arguments)
  }

  getByShortId() {
    var userModel = new UserModel()

    userModel.getByShortId.apply(userModel, arguments)
  }

  getByUsername() {
    var userModel = new UserModel()

    userModel.getByUsername.apply(userModel, arguments)
  }

  list() {

    var userModel = new UserModel()

    userModel.list.apply(userModel, arguments)

  }

  update() {
    var userModel = new UserModel()

    userModel.update.apply(userModel, arguments)
  }

  updateByShortId() {
    var userModel = new UserModel()

    userModel.updateByShortId.apply(userModel, arguments)
  }

}

export default UserService
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
